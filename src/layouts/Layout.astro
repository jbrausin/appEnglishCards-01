---
// src/layouts/Layout.astro
import Sidebar from '../components/Sidebar.astro';
import { supabase } from '../lib/supabase';

export interface Props {
	title: string;
}

const { title } = Astro.props;
---

<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
		<title>{title}</title>
	</head>
	<body>
		<div class="min-h-screen bg-white">
			<div class="container mx-auto p-6">
				<div class="bg-card rounded-xl shadow-lg overflow-hidden mb-8">
					<div class="grid grid-cols-12">
						<!-- Sidebar -->
						<div class="col-span-12 md:col-span-3 lg:col-span-2 bg-dark text-white">
							<Sidebar />
						</div>
						
						<!-- Main Content -->
						<div class="col-span-12 md:col-span-9 lg:col-span-10 p-6 bg-light">
							<slot />
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Modal para crear idioma -->
		<div id="create-language-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
			<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
				<h3 class="text-xl font-bold mb-4">Crear nuevo idioma</h3>
				<form id="create-language-form">
					<div class="mb-6">
						<label for="language-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre del idioma</label>
						<input
							type="text"
							id="language-name"
							name="language-name"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
							placeholder="Ej: Inglés, Francés, Alemán..."
							required
						/>
					</div>
					
					<div class="flex justify-end space-x-3">
						<button type="button" id="cancel-create-language" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
							Cancelar
						</button>
						<button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
							Guardar
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Modal para editar idioma -->
		<div id="edit-language-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
			<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
				<h3 class="text-xl font-bold mb-4">Editar idioma</h3>
				<form id="edit-language-form">
					<div class="mb-6">
						<label for="edit-language-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre del idioma</label>
						<input
							type="text"
							id="edit-language-name"
							name="edit-language-name"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
							required
						/>
					</div>
					
					<div class="flex justify-end space-x-3">
						<button type="button" id="cancel-edit-language" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
							Cancelar
						</button>
						<button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
							Guardar
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Modal para crear grupo -->
		<div id="create-group-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
			<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
				<h3 class="text-xl font-bold mb-4">Crear nuevo grupo</h3>
				<form id="create-group-form">
					<input type="hidden" id="group-language-id" name="group-language-id">
					<div class="mb-6">
						<label for="group-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre del grupo</label>
						<input
							type="text"
							id="group-name"
							name="group-name"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
							placeholder="Ej: Frases básicas, Vocabulario de viaje..."
							required
						/>
					</div>
					
					<div class="flex justify-end space-x-3">
						<button type="button" id="cancel-create-group" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
							Cancelar
						</button>
						<button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
							Guardar
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Modal para editar grupo -->
		<div id="edit-group-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
			<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
				<h3 class="text-xl font-bold mb-4">Editar grupo</h3>
				<form id="edit-group-form">
					<input type="hidden" id="edit-group-language-id" name="edit-group-language-id">
					<div class="mb-6">
						<label for="edit-group-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre del grupo</label>
						<input
							type="text"
							id="edit-group-name"
							name="edit-group-name"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
							required
						/>
					</div>
					
					<div class="flex justify-end space-x-3">
						<button type="button" id="cancel-edit-group" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
							Cancelar
						</button>
						<button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
							Guardar
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Modal para añadir tarjeta -->
		<div id="add-card-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
			<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
				<h3 class="text-xl font-bold mb-4">Añadir nueva tarjeta</h3>
				<form id="add-card-form">
					<div class="mb-4">
						<label for="card-english" class="block text-sm font-medium text-gray-700 mb-2">Frase en inglés</label>
						<input
							type="text"
							id="card-english"
							name="card-english"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
							placeholder="Escribe la frase en inglés"
							required
						/>
					</div>
					
					<div class="mb-6">
						<label for="card-translation" class="block text-sm font-medium text-gray-700 mb-2">Traducción</label>
						<input
							type="text"
							id="card-translation"
							name="card-translation"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
							placeholder="Escribe la traducción en español"
							required
						/>
					</div>
					
					<div class="flex justify-end space-x-3">
						<button type="button" id="cancel-add-card" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
							Cancelar
						</button>
						<button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
							Guardar
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Modal de confirmación para eliminar idioma -->
		<div id="delete-language-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
			<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
				<h3 class="text-xl font-bold mb-4">Confirmar eliminación</h3>
				<p class="mb-6">¿Estás seguro de que deseas eliminar este idioma? Se eliminarán todos los grupos y tarjetas asociadas. Esta acción no se puede deshacer.</p>
				<div class="flex justify-end space-x-3">
					<button id="cancel-delete-language" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
						Cancelar
					</button>
					<button id="confirm-delete-language" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
						Eliminar
					</button>
				</div>
			</div>
		</div>

		<!-- Modal de confirmación para eliminar grupo -->
		<div id="delete-group-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
			<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
				<h3 class="text-xl font-bold mb-4">Confirmar eliminación</h3>
				<p class="mb-6">¿Estás seguro de que deseas eliminar este grupo? Se eliminarán todas las tarjetas asociadas. Esta acción no se puede deshacer.</p>
				<input type="hidden" id="delete-group-language-id" name="delete-group-language-id">
				<div class="flex justify-end space-x-3">
					<button id="cancel-delete-group" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
						Cancelar
					</button>
					<button id="confirm-delete-group" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
						Eliminar
					</button>
				</div>
			</div>
		</div>

		<!-- Modal para editar tarjeta -->
		<div id="edit-card-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
			<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
				<h3 class="text-xl font-bold mb-4">Editar tarjeta</h3>
				<form id="edit-card-form">
					<input type="hidden" id="edit-card-id" name="edit-card-id">
					<input type="hidden" id="edit-card-group-id" name="edit-card-group-id">
					<div class="mb-4">
						<label for="edit-card-english" class="block text-sm font-medium text-gray-700 mb-2">Frase en inglés</label>
						<input
							type="text"
							id="edit-card-english"
							name="edit-card-english"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
							required
						/>
					</div>
					
					<div class="mb-6">
						<label for="edit-card-translation" class="block text-sm font-medium text-gray-700 mb-2">Traducción</label>
						<input
							type="text"
							id="edit-card-translation"
							name="edit-card-translation"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
							required
						/>
					</div>
					
					<div class="flex justify-end space-x-3">
						<button type="button" id="cancel-edit-card" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
							Cancelar
						</button>
						<button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
							Guardar
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Modal de confirmación para eliminar tarjeta -->
		<div id="delete-card-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
			<div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
				<h3 class="text-xl font-bold mb-4">Confirmar eliminación</h3>
				<p class="mb-6">¿Estás seguro de que deseas eliminar esta tarjeta? Esta acción no se puede deshacer.</p>
				<input type="hidden" id="delete-card-id" name="delete-card-id">
				<input type="hidden" id="delete-card-group-id" name="delete-card-group-id">
				<div class="flex justify-end space-x-3">
					<button id="cancel-delete-card" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
						Cancelar
					</button>
					<button id="confirm-delete-card" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
						Eliminar
					</button>
				</div>
			</div>
		</div>

		<!-- Toast notifications -->
		<div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>
	</body>
</html>

<style is:global>
	:root {
		--accent: 124, 58, 237;
		--accent-gradient: linear-gradient(45deg, rgb(var(--accent)), #da62c4 30%, white 60%);
	}
	html {
		font-family: 'Poppins', system-ui, sans-serif;
		background-color: #f8f8f6;
	}
	code {
		font-family: Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono,
			Bitstream Vera Sans Mono, Courier New, monospace;
	}
	.container {
		max-width: 1280px;
	}
</style>

<script>
	import { 
		createLanguage,
		updateLanguage,
		deleteLanguage,
		createGroup,
		updateGroup,
		deleteGroup,
		createCard,
		updateCard,
		deleteCard,
		toggleCardLearned
	} from '../lib/supabase';

	// Definir tipos para funciones globales
	declare global {
		interface Window {
			openCreateLanguageModal: typeof openCreateLanguageModal;
			openEditLanguageModal: typeof openEditLanguageModal;
			openDeleteLanguageModal: typeof openDeleteLanguageModal;
			openCreateGroupModal: typeof openCreateGroupModal;
			openEditGroupModal: typeof openEditGroupModal;
			openAddCardModal: typeof openAddCardModal;
			openDeleteGroupModal: typeof openDeleteGroupModal;
			openEditCardModal: typeof openEditCardModal;
			openDeleteCardModal: typeof openDeleteCardModal;
		}
	}
	
	// Variables para modales
	let currentLanguageId: string | null = null;
	let currentGroupId: string | null = null;
	let currentCardId: string | null = null;
	
	// Toast notification function
	function showToast(message: string, type = 'success', duration = 3000) {
		const toastContainer = document.getElementById('toast-container');
		if (!toastContainer) return;
		
		const toast = document.createElement('div');
		toast.className = `p-4 mb-3 rounded-lg shadow-lg transition-opacity duration-300 ${
			type === 'success' ? 'bg-green-500' : 'bg-red-500'
		} text-white`;
		toast.textContent = message;
		
		toastContainer.appendChild(toast);
		
		// Eliminar el toast después de la duración especificada
		setTimeout(() => {
			toast.classList.add('opacity-0');
			setTimeout(() => {
				toast.remove();
			}, 300);
		}, duration);
	}
	
	// Funciones para los modales de idioma
	function openCreateLanguageModal() {
		const modal = document.getElementById('create-language-modal');
		if (modal) {
			modal.classList.remove('hidden');
			const input = document.getElementById('language-name');
			if (input && input instanceof HTMLInputElement) input.focus();
		}
	}
	
	function closeCreateLanguageModal() {
		const modal = document.getElementById('create-language-modal');
		if (modal) {
			modal.classList.add('hidden');
			const form = document.getElementById('create-language-form');
			if (form && form instanceof HTMLFormElement) form.reset();
		}
	}
	
	function openEditLanguageModal(languageId: string, languageName: string) {
		const modal = document.getElementById('edit-language-modal');
		const input = document.getElementById('edit-language-name');
		
		if (modal && input && input instanceof HTMLInputElement) {
			currentLanguageId = languageId;
			input.value = languageName;
			modal.classList.remove('hidden');
			input.focus();
		}
	}
	
	function closeEditLanguageModal() {
		const modal = document.getElementById('edit-language-modal');
		if (modal) {
			modal.classList.add('hidden');
			currentLanguageId = null;
		}
	}
	
	function openDeleteLanguageModal(languageId: string) {
		const modal = document.getElementById('delete-language-modal');
		if (modal) {
			currentLanguageId = languageId;
			modal.classList.remove('hidden');
		}
	}
	
	function closeDeleteLanguageModal() {
		const modal = document.getElementById('delete-language-modal');
		if (modal) {
			modal.classList.add('hidden');
			currentLanguageId = null;
		}
	}
	
	// Funciones para los modales de grupo
	function openCreateGroupModal(languageId: string) {
		const modal = document.getElementById('create-group-modal');
		const languageIdInput = document.getElementById('group-language-id');
		
		if (modal && languageIdInput && languageIdInput instanceof HTMLInputElement) {
			languageIdInput.value = languageId;
			modal.classList.remove('hidden');
			const input = document.getElementById('group-name');
			if (input && input instanceof HTMLInputElement) input.focus();
		}
	}
	
	function closeCreateGroupModal() {
		const modal = document.getElementById('create-group-modal');
		if (modal) {
			modal.classList.add('hidden');
			const form = document.getElementById('create-group-form');
			if (form && form instanceof HTMLFormElement) form.reset();
		}
	}
	
	function openEditGroupModal(groupId: string, groupName: string, languageId: string) {
		const modal = document.getElementById('edit-group-modal');
		const input = document.getElementById('edit-group-name');
		const languageIdInput = document.getElementById('edit-group-language-id');
		
		if (modal && input && input instanceof HTMLInputElement && languageIdInput && languageIdInput instanceof HTMLInputElement) {
			currentGroupId = groupId;
			input.value = groupName;
			languageIdInput.value = languageId;
			modal.classList.remove('hidden');
			input.focus();
		}
	}
	
	function closeEditGroupModal() {
		const modal = document.getElementById('edit-group-modal');
		if (modal) {
			modal.classList.add('hidden');
			currentGroupId = null;
		}
	}
	
	function openAddCardModal(groupId: string) {
		const modal = document.getElementById('add-card-modal');
		if (modal) {
			currentGroupId = groupId;
			modal.classList.remove('hidden');
			const input = document.getElementById('card-english');
			if (input && input instanceof HTMLInputElement) input.focus();
		}
	}
	
	function closeAddCardModal() {
		const modal = document.getElementById('add-card-modal');
		if (modal) {
			modal.classList.add('hidden');
			const form = document.getElementById('add-card-form');
			if (form && form instanceof HTMLFormElement) form.reset();
			currentGroupId = null;
		}
	}
	
	function openDeleteGroupModal(groupId: string, languageId: string) {
		const modal = document.getElementById('delete-group-modal');
		const languageIdInput = document.getElementById('delete-group-language-id');
		
		if (modal && languageIdInput && languageIdInput instanceof HTMLInputElement) {
			currentGroupId = groupId;
			languageIdInput.value = languageId;
			modal.classList.remove('hidden');
		}
	}
	
	function closeDeleteGroupModal() {
		const modal = document.getElementById('delete-group-modal');
		if (modal) {
			modal.classList.add('hidden');
			currentGroupId = null;
		}
	}
	
	function openEditCardModal(cardId: string, english: string, translation: string, groupId?: string) {
		const modal = document.getElementById('edit-card-modal');
		const idInput = document.getElementById('edit-card-id');
		const groupIdInput = document.getElementById('edit-card-group-id');
		const englishInput = document.getElementById('edit-card-english');
		const translationInput = document.getElementById('edit-card-translation');
		
		if (modal && idInput && groupIdInput && englishInput && translationInput) {
			currentCardId = cardId;
			if (idInput instanceof HTMLInputElement) idInput.value = cardId;
			if (groupIdInput instanceof HTMLInputElement) groupIdInput.value = groupId || (currentGroupId || "");
			if (englishInput instanceof HTMLInputElement) englishInput.value = english;
			if (translationInput instanceof HTMLInputElement) translationInput.value = translation;
			
			modal.classList.remove('hidden');
			if (englishInput instanceof HTMLInputElement) englishInput.focus();
		}
	}
	
	function closeEditCardModal() {
		const modal = document.getElementById('edit-card-modal');
		if (modal) {
			modal.classList.add('hidden');
			currentCardId = null;
		}
	}
	
	function openDeleteCardModal(cardId: string, groupId?: string) {
		const modal = document.getElementById('delete-card-modal');
		const idInput = document.getElementById('delete-card-id');
		const groupIdInput = document.getElementById('delete-card-group-id');
		
		if (modal && idInput && groupIdInput) {
			currentCardId = cardId;
			if (idInput instanceof HTMLInputElement) idInput.value = cardId;
			if (groupIdInput instanceof HTMLInputElement) groupIdInput.value = groupId || (currentGroupId || "");
			modal.classList.remove('hidden');
		}
	}
	
	function closeDeleteCardModal() {
		const modal = document.getElementById('delete-card-modal');
		if (modal) {
			modal.classList.add('hidden');
			currentCardId = null;
		}
	}
	
	// Configurar event listeners al cargar el DOM
	document.addEventListener('DOMContentLoaded', () => {
		// Event listeners para modales de idiomas
		document.getElementById('cancel-create-language')?.addEventListener('click', closeCreateLanguageModal);
		document.getElementById('cancel-edit-language')?.addEventListener('click', closeEditLanguageModal);
		document.getElementById('cancel-delete-language')?.addEventListener('click', closeDeleteLanguageModal);
		
		// Event listeners para modales de grupos
		document.getElementById('cancel-create-group')?.addEventListener('click', closeCreateGroupModal);
		document.getElementById('cancel-edit-group')?.addEventListener('click', closeEditGroupModal);
		document.getElementById('cancel-add-card')?.addEventListener('click', closeAddCardModal);
		document.getElementById('cancel-delete-group')?.addEventListener('click', closeDeleteGroupModal);
		
		// Event listeners para modales de tarjetas
		document.getElementById('cancel-edit-card')?.addEventListener('click', closeEditCardModal);
		document.getElementById('cancel-delete-card')?.addEventListener('click', closeDeleteCardModal);
		
		// Formulario para crear idioma
		const createLanguageForm = document.getElementById('create-language-form');
		createLanguageForm?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const nameInput = document.getElementById('language-name');
			
			if (!nameInput || !(nameInput instanceof HTMLInputElement)) return;
			
			const languageName = nameInput.value.trim();
			
			if (languageName) {
				try {
					// Crear idioma usando Supabase
					await createLanguage(languageName);
					
					// Cerrar modal y mostrar notificación
					closeCreateLanguageModal();
					showToast('¡Idioma creado con éxito!');
					
					// Recargar la página para mostrar el nuevo idioma
					window.location.reload();
				} catch (error) {
					console.error('Error al crear idioma:', error);
					showToast('Error al crear idioma. Inténtalo de nuevo.', 'error');
				}
			}
		});
		
		// Formulario para editar idioma
		const editLanguageForm = document.getElementById('edit-language-form');
		editLanguageForm?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const nameInput = document.getElementById('edit-language-name');
			
			if (!nameInput || !(nameInput instanceof HTMLInputElement)) return;
			
			const languageName = nameInput.value.trim();
			
			if (languageName && currentLanguageId) {
				try {
					// Actualizar idioma con Supabase
					await updateLanguage(currentLanguageId, languageName);
					
					// Cerrar modal y mostrar notificación
					closeEditLanguageModal();
					showToast('¡Idioma actualizado con éxito!');
					
					// Recargar la página para mostrar los cambios
					window.location.reload();
				} catch (error) {
					console.error('Error al actualizar idioma:', error);
					showToast('Error al actualizar idioma. Inténtalo de nuevo.', 'error');
				}
			}
		});
		
		// Formulario para crear grupo
		const createGroupForm = document.getElementById('create-group-form');
		createGroupForm?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const nameInput = document.getElementById('group-name');
			const languageIdInput = document.getElementById('group-language-id');
			
			if (!nameInput || !(nameInput instanceof HTMLInputElement) || 
				!languageIdInput || !(languageIdInput instanceof HTMLInputElement)) return;
			
			const groupName = nameInput.value.trim();
			const languageId = languageIdInput.value;
			
			if (groupName && languageId) {
				try {
					// Crear grupo con Supabase
					await createGroup(groupName, languageId);
					
					// Cerrar modal y mostrar notificación
					closeCreateGroupModal();
					showToast('¡Grupo creado con éxito!');
					
					// Recargar la página para mostrar el nuevo grupo
					window.location.reload();
				} catch (error) {
					console.error('Error al crear grupo:', error);
					showToast('Error al crear grupo. Inténtalo de nuevo.', 'error');
				}
			}
		});
		
		// Formulario para editar grupo
		const editGroupForm = document.getElementById('edit-group-form');
		editGroupForm?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const nameInput = document.getElementById('edit-group-name');
			
			if (!nameInput || !(nameInput instanceof HTMLInputElement) || !currentGroupId) return;
			
			const groupName = nameInput.value.trim();
			
			if (groupName) {
				try {
					// Actualizar grupo con Supabase
					await updateGroup(currentGroupId, groupName);
					
					// Cerrar modal y mostrar notificación
					closeEditGroupModal();
					showToast('¡Grupo actualizado con éxito!');
					
					// Recargar la página para mostrar los cambios
					window.location.reload();
				} catch (error) {
					console.error('Error al actualizar grupo:', error);
					showToast('Error al actualizar grupo. Inténtalo de nuevo.', 'error');
				}
			}
		});
		
		// Formulario para añadir tarjeta
		const addCardForm = document.getElementById('add-card-form');
		addCardForm?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const englishInput = document.getElementById('card-english');
			const translationInput = document.getElementById('card-translation');
			
			if (!englishInput || !(englishInput instanceof HTMLInputElement) || 
				!translationInput || !(translationInput instanceof HTMLInputElement) || 
				!currentGroupId) return;
			
			const english = englishInput.value.trim();
			const translation = translationInput.value.trim();
			
			if (english && translation) {
				try {
					// Crear tarjeta con Supabase
					await createCard(english, translation, currentGroupId);
					
					// Cerrar modal y mostrar notificación
					closeAddCardModal();
					showToast('¡Tarjeta añadida con éxito!');
					
					// Recargar la página si estamos en la vista de estudio
					window.location.reload();
				} catch (error) {
					console.error('Error al crear tarjeta:', error);
					showToast('Error al crear tarjeta. Inténtalo de nuevo.', 'error');
				}
			}
		});
		
		// Formulario para editar tarjeta
		const editCardForm = document.getElementById('edit-card-form');
		editCardForm?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const englishInput = document.getElementById('edit-card-english');
			const translationInput = document.getElementById('edit-card-translation');
			
			if (!englishInput || !(englishInput instanceof HTMLInputElement) || 
				!translationInput || !(translationInput instanceof HTMLInputElement) || 
				!currentCardId) return;
			
			const english = englishInput.value.trim();
			const translation = translationInput.value.trim();
			
			if (english && translation) {
				try {
					// Actualizar tarjeta con Supabase
					await updateCard(currentCardId, { english, translation });
					
					// Cerrar modal y mostrar notificación
					closeEditCardModal();
					showToast('¡Tarjeta actualizada con éxito!');
					
					// Recargar la página
					window.location.reload();
				} catch (error) {
					console.error('Error al actualizar tarjeta:', error);
					showToast('Error al actualizar tarjeta. Inténtalo de nuevo.', 'error');
				}
			}
		});

		// Confirmar eliminación de idioma
		document.getElementById('confirm-delete-language')?.addEventListener('click', async () => {
			if (currentLanguageId) {
				try {
					// Eliminar idioma con Supabase
					await deleteLanguage(currentLanguageId);
					
					// Cerrar modal y mostrar notificación
					closeDeleteLanguageModal();
					showToast('Idioma eliminado correctamente');
					
					// Recargar la página
					window.location.reload();
				} catch (error) {
					console.error('Error al eliminar idioma:', error);
					showToast('Error al eliminar idioma. Inténtalo de nuevo.', 'error');
				}
			}
		});
		
		// Confirmar eliminación de grupo
		document.getElementById('confirm-delete-group')?.addEventListener('click', async () => {
			if (currentGroupId) {
				try {
					// Eliminar grupo con Supabase
					await deleteGroup(currentGroupId);
					
					// Cerrar modal y mostrar notificación
					closeDeleteGroupModal();
					showToast('Grupo eliminado correctamente');
					
					// Redirigir a la página de idioma si estamos en la vista de estudio
					if (window.location.pathname.includes('/study/')) {
						const languageIdInput = document.getElementById('delete-group-language-id');
						if (languageIdInput && languageIdInput instanceof HTMLInputElement) {
							window.location.href = `/language/${languageIdInput.value}`;
						} else {
							window.location.href = '/';
						}
					} else {
						// Recargar la página para actualizar la lista de grupos
						window.location.reload();
					}
				} catch (error) {
					console.error('Error al eliminar grupo:', error);
					showToast('Error al eliminar grupo. Inténtalo de nuevo.', 'error');
				}
			}
		});
		
		// Confirmar eliminación de tarjeta
		document.getElementById('confirm-delete-card')?.addEventListener('click', async () => {
			if (currentCardId) {
				try {
					// Eliminar tarjeta con Supabase
					await deleteCard(currentCardId);
					
					// Cerrar modal y mostrar notificación
					closeDeleteCardModal();
					showToast('Tarjeta eliminada correctamente');
					
					// Recargar la página
					window.location.reload();
				} catch (error) {
					console.error('Error al eliminar tarjeta:', error);
					showToast('Error al eliminar tarjeta. Inténtalo de nuevo.', 'error');
				}
			}
		});
	});
	
	// Exportar funciones para uso global
	if (typeof window !== 'undefined') {
		window.openCreateLanguageModal = openCreateLanguageModal;
		window.openEditLanguageModal = openEditLanguageModal;
		window.openDeleteLanguageModal = openDeleteLanguageModal;
		window.openCreateGroupModal = openCreateGroupModal;
		window.openEditGroupModal = openEditGroupModal;
		window.openAddCardModal = openAddCardModal;
		window.openDeleteGroupModal = openDeleteGroupModal;
		window.openEditCardModal = openEditCardModal;
		window.openDeleteCardModal = openDeleteCardModal;
	}
</script>